[[ch03_bitcoin_client]]
== Bitcoin Core: L'implementazione di riferimento

La gente accetta denaro in cambio di beni e servizi solo se è convinta di poterlo spendere in futuro. Denaro contraffatto o svalutato in maniera inattesa potrebbe non essere accettato in futuro; perciò chiunque riceva bitcoin ha un forte incentivo a verificare che non ci siano problemi nella rete. Il sistema Bitcoin è stato progettato affinché il software in esecuzione sul computer locale possa prevenire perfettamente la contraffazione, la svalutazione e altri problemi critici. Il software che fornisce questa funzione è chiamato _nodo di verifica completa_, perché verifica ogni transazione Bitcoin confermata rispetto a tutte le regole del sistema. I nodi di verifica completa, o semplicemente _nodi completi_ (full nodes), forniscono inoltre strumenti e dati utili per comprendere il funzionamento di Bitcoin e cosa sta succedendo attualmente nella rete.

In questo capitolo installeremo Bitcoin Core, l'implementazione utilizzata dalla maggior parte degli operatori di full nodes fin dall'inizio della rete Bitcoin. Successivamente analizzeremo blocchi, transazioni e altri dati provenienti dal nodo, dati che sono autorevoli non perché lo abbia deciso qualche entità potente, ma perché quel nodo li ha verificati autonomamente. Nel resto del libro continueremo a usare Bitcoin Core per creare ed esaminare dati relativi alla blockchain e alla rete.

=== Da Bitcoin a Bitcoin Core

Bitcoin è un progetto _open source_ e il codice sorgente è disponibile con una licenza aperta (MIT), scaricabile gratuitamente e utilizzabile per qualsiasi scopo. Oltre ad essere open source, Bitcoin è sviluppato da una comunità aperta di volontari. Inizialmente questa comunità era composta soltanto da Satoshi Nakamoto. Nel 2023 il codice sorgente di Bitcoin contava oltre 1.000 contributori, con circa una dozzina di sviluppatori che lavorano al codice quasi a tempo pieno e diverse decine di altri che contribuiscono part‑time. Chiunque può contribuire al codice—compreso te!

Quando Bitcoin fu creato da Satoshi Nakamoto, il software era già in gran parte completato prima della pubblicazione del whitepaper (puoi leggerlo in <<satoshi_whitepaper>>). Satoshi voleva assicurarsi che l'implementazione funzionasse correttamente prima di pubblicare il documento che lo descriveva. Quella prima implementazione, nota semplicemente come “Bitcoin”, è stata pesantemente modificata e migliorata nel tempo. È evoluta in ciò che oggi chiamiamo _Bitcoin Core_, per distinguerla da altre implementazioni. Bitcoin Core è l'_implementazione di riferimento_ del sistema Bitcoin, il che significa che fornisce un riferimento per come ogni parte della tecnologia dovrebbe essere implementata. Bitcoin Core implementa tutti gli aspetti di Bitcoin, compresi wallet, un motore di validazione di transazioni e blocchi, strumenti per la costruzione di blocchi, e tutte le parti moderne della comunicazione peer‑to‑peer di Bitcoin.

<<bitcoin_core_architecture>> mostra l'architettura di Bitcoin Core.

[[bitcoin_core_architecture]]
.Architettura di Bitcoin Core (Source: Eric Lombrozo).
image::images/mbc3_0301.png["Bitcoin Core Architecture"]

Anche se Bitcoin Core rappresenta l'implementazione di riferimento per molte parti fondamentali del sistema, il whitepaper di Bitcoin descrive diverse delle prime componenti del progetto. La maggior parte degli aggiornamenti più importanti dal 2011 in poi è documentata nei https://oreil.ly/BCXAQ[Bitcoin Improvement Proposals (BIP))]. Nel corso di questo libro, ci riferiamo a queste specifiche BIP utilizzando il loro numero; ad esempio, il BIP9 descrive un meccanismo utilizzato per diversi aggiornamenti importanti di Bitcoin.

=== Ambiente di sviluppo Bitcoin

Se sei uno sviluppatore, vorrai configurare un ambiente di sviluppo con tutti gli strumenti, le librerie e i software di supporto necessari per scrivere applicazioni Bitcoin. In questo capitolo molto tecnico, vedremo passo per passo come farlo. Se trovi che l'argomento diventa troppo complesso (e non stai effettivamente configurando un ambiente di sviluppo), puoi tranquillamente passare al capitolo successivo, meno tecnico.

[[compiling_core]]
=== Compilare Bitcoin Core dal codice sorgente

Il codice sorgente di Bitcoin Core può essere scaricato come file zip o clonando il repository GitHub. Vai alla https://oreil.ly/hN9g1[pagina di download di Bitcoin Core], seleziona la versione più recente e scarica il file zip del codice sorgente. In alternativa, utilizza il comando Git per creare una copia locale del codice sorgente dalla https://oreil.ly/BdOwl[GitHub di Bitcoin].

[TIP]
====
In molti degli esempi di questo capitolo, useremo l'interfaccia a riga di comando del sistema operativo (nota anche come “shell”), accessibile tramite un'applicazione “terminale”. La shell mostrerà un prompt, digiterai un comando e la shell risponderà con del testo e un nuovo prompt per il comando successivo. Il prompt potrebbe apparire diverso sul tuo sistema, ma negli esempi seguenti lo indicheremo con il simbolo +$+ .
Negli esempi, quando vedi del testo dopo il simbolo +$+ , non digitare il simbolo +$+ ma digita il comando che segue immediatamente, poi premi Invio per eseguire il comando. Negli esempi, le righe sotto ogni comando sono le risposte del sistema operativo a quel comando. Quando vedi il prossimo prefisso +$+, saprai che è un nuovo comando e dovresti ripetere il processo.
====

Qui utilizziamo il comando +git+ per creare una copia locale (“clone”) del codice sorgente:

----
$ git clone https://github.com/bitcoin/bitcoin.git
Cloning into 'bitcoin'...
remote: Enumerating objects: 245912, done.
remote: Counting objects: 100% (3/3), done.
remote: Compressing objects: 100% (2/2), done.
remote: Total 245912 (delta 1), reused 2 (delta 1), pack-reused 245909
Receiving objects: 100% (245912/245912), 217.74 MiB | 13.05 MiB/s, done.
Resolving deltas: 100% (175649/175649), done.
----

[TIP]
====
Git è il sistema di controllo versione distribuito più utilizzato, una parte essenziale del toolkit di qualsiasi sviluppatore software. Potresti dover installare il comando +git+, o un'interfaccia grafica per Git, sul tuo sistema operativo se non lo hai già.
====

Quando l'operazione di clonazione Git è completata, avrai una copia locale completa del repository del codice sorgente nella directory _bitcoin_. Spostati in questa directory utilizzando il comando +cd+:

----
$ cd bitcoin
----

==== Selezionare una versione di Bitcoin Core

Per impostazione predefinita, la copia locale sarà sincronizzata con il codice più recente, che potrebbe essere una versione instabile o beta di Bitcoin. Prima di compilare il codice, seleziona una versione specifica facendo il checkout di un _tag_ di release. Questo sincronizzerà la copia locale con uno snapshot specifico del repository del codice identificato da un tag. I tag sono utilizzati dagli sviluppatori per contrassegnare release specifiche del codice in base al numero di versione. Per prima cosa, per trovare i tag disponibili, utilizziamo il comando +git tag+:

----
$ git tag
v0.1.5
v0.1.6test1
v0.10.0
...
v0.11.2
v0.11.2rc1
v0.12.0rc1
v0.12.0rc2
...
----

La lista dei tag mostra tutte le versioni rilasciate di Bitcoin. Per convenzione, i _release candidate_, che sono destinati ai test, hanno il suffisso “rc”. Le release stabili che possono essere eseguite sui sistemi di produzione non hanno suffisso. Dalla lista precedente, seleziona la versione release più alta, che al momento della scrittura era v24.0.1. Per sincronizzare il codice locale con questa versione, utilizza il comando +git checkout+:

----
$ git checkout v24.0.1
Note: switching to 'v24.0.1'.

You are in 'detached HEAD' state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by switching back to a branch.

HEAD is now at b3f866a8d Merge bitcoin/bitcoin#26647: 24.0.1 final changes
----

Puoi confermare di avere la versione desiderata “checked out” eseguendo il comando +git status+:

----
HEAD detached at v24.0.1
nothing to commit, working tree clean
----

==== Configurare la build di Bitcoin Core

Il codice sorgente include documentazione, che può essere trovata in diversi file. Esamina la documentazione principale situata in _README.md_ nella directory _bitcoin_. In questo capitolo costruiremo il daemon di Bitcoin Core (server), noto anche come +bitcoind+ su Linux (un sistema simile a Unix). Esamina le istruzioni per compilare il daemon +bitcoind+ in _doc/build-unix.md_.

Prima di poter compilare, devi prima creare gli script di build eseguendo lo script +autogen.sh+:

----
$ ./autogen.sh
----

Successivamente, configuri il processo di build utilizzando lo script +configure+. Questo script ti consente di abilitare o disabilitare certe funzionalità di Bitcoin Core. Per un elenco completo delle funzionalità, esegui +./configure --help+.

In questo caso, configureremo la build senza l'interfaccia grafica utente, poiché intendiamo eseguire Bitcoin Core come server (daemon) dalla riga di comando. Istruiamo anche lo script configure a non eseguire alcun controllo del database relativo al wallet durante la verifica, il che può accelerare il download iniziale dei blocchi. Infine, gli chiediamo di abilitare la funzionalità di notifica degli eventi ZeroMQ (ZMQ), che utilizzeremo più avanti in questo capitolo:

----
$ ./configure --without-gui --with-incompatible-bdb --enable-zmq
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a thread‑safe mkdir -p... /bin/mkdir -p
checking for gawk... gawk
checking whether make sets $(MAKE)... yes
checking whether make supports nested variables... yes
checking for gcc... gcc
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out
checking for suffix of executables...
checking whether we are cross compiling... no
checking for suffix of object files... o
checking whether we are using the GNU C compiler... yes
checking whether gcc accepts -g... yes
checking for gcc option to accept ISO C89... none needed
checking whether gcc understands -c and -o together... yes
checking for style of include used by make... GNU
checking dependency style of gcc... gcc3
checking for g++... g++
checking whether we are using the GNU C++ compiler... yes
checking whether g++ accepts -g... yes
checking dependency style of g++... gcc3
checking for pkg-config... /usr/bin/pkg-config
checking pkg-config is at least version 0.9.0... yes
checking for lib-bdb-5.3... no
checking for lib-bdb-4.8... no
checking for BDB... no
checking for Berkeley DB C++ headers... no
checking for Berkeley DB... no
configure: error: Found no Berkeley DB headers
----

==== Risolvere le dipendenze di build

Come puoi vedere, lo script +configure+ testa tutte le librerie software e gli strumenti necessari per compilare Bitcoin Core. Questi sono chiamati _dipendenze_. Se una dipendenza manca, lo script +configure+ uscirà con un errore. In questo caso, lo script non è riuscito a trovare la libreria Berkeley DB, che è necessaria per la funzionalità del wallet.

Bitcoin Core ha diverse dipendenze, che sono esse stesse progetti software open source. Per compilare Bitcoin Core, devi prima installare queste dipendenze. Lo script +configure+ verificherà la loro presenza e si fermerà se qualcuna manca. Le principali dipendenze sono:

Boost::
    Una libreria C++, versione 1.65.0 o successiva

libevent::
    Una libreria I/O asincrona basata su eventi

Berkeley DB::
    Una libreria di database key-value, per la funzionalità del wallet

ZeroMQ (opzionale)::
    Una libreria di messaggistica, per le notifiche degli eventi

Su una distribuzione Linux basata su Debian, come Ubuntu, puoi installare queste dipendenze con un singolo comando:

----
$ sudo apt-get install build-essential libtool autotools-dev automake pkg-config \
  libssl-dev libevent-dev bsdmainutils python3 libboost-all-dev
----

Per il supporto del wallet, devi anche installare Berkeley DB v4.8. Questo può essere complicato su alcuni sistemi, perché la maggior parte delle distribuzioni Linux ha versioni più recenti di Berkeley DB. Bitcoin Core utilizza la versione 4.8 per la compatibilità del wallet con le versioni precedenti di Bitcoin Core. Per installare Berkeley DB v4.8, potrebbe essere necessario compilarla dal codice sorgente o utilizzare un repository di pacchetti speciale. Su Ubuntu, puoi utilizzare il PPA (Personal Package Archive) di Bitcoin per installare questa versione specifica:

[source,console]
----
$ sudo add-apt-repository ppa:bitcoin/bitcoin
$ sudo apt-get update
$ sudo apt-get install libdb4.8-dev libdb4.8++-dev
----

Se vuoi utilizzare la funzionalità ZeroMQ (ZMQ), dovrai installare la libreria +libzmq+:

----
$ sudo apt-get install libzmq3-dev
----

Una volta installate tutte le dipendenze necessarie, esegui nuovamente lo script +./configure+. Se si completa senza errori, stamperà un riassunto della configurazione, come questo:

----
Options used to compile and link:
  with wallet = yes
  with gui = no
  with zmq = yes
  with test = yes
  with bench = yes
  with upnp = yes
  use asm = yes

  target os = linux
  build os =

  CC = gcc
  CFLAGS = -g -O2
  CPPFLAGS = -DHAVE_CONFIG_H
  CXX = g++
  CXXFLAGS = -g -O2 -std=c++17
  LDFLAGS =
  LIBS = -lpthread
----

==== Compilare +bitcoind+

Successivamente, compilerai il codice sorgente, un processo che può richiedere fino a un'ora per completarsi, a seconda della velocità della CPU e della memoria disponibile (RAM). Durante il processo di compilazione, vedrai molti messaggi scorrere, che sono i comandi eseguiti dal tool +make+.

Per iniziare la compilazione, digita +make+:

----
$ make
Making all in src
make[1]: Entering directory '/home/user/bitcoin/src'
  CXX      libbitcoin_common_a-chainparams.o
  CXX      libbitcoin_common_a-util.o
  ...
  CXXLD    bitcoind
make[1]: Leaving directory '/home/user/bitcoin/src'
...
----

Se tutto va bene, Bitcoin Core è ora compilato. I programmi eseguibili risultanti si trovano nella sottodirectory _bitcoin/src_. I programmi principali che utilizzeremo sono:

+bitcoind+::
    Il server Bitcoin Core (daemon)

+bitcoin-cli+::
    Il client dell'interfaccia a riga di comando (CLI) di Bitcoin Core, che può essere utilizzato per controllare il daemon

+bitcoin-tx+::
    Uno strumento per le transazioni, per creare e analizzare transazioni

Opzionalmente, esegui i test per assicurarti che la build funzioni correttamente:

----
$ make check
...
Test suite summary
==================
# TOTAL: 100
# PASS:  100
# SKIP:  0
# XFAIL: 0
# XPASS: 0
# ERROR: 0
==================
...
----

Infine, installa gli eseguibili in una directory di sistema, come _/usr/local/bin_, così possono essere eseguiti da qualsiasi posizione:

----
$ sudo make install
----

=== Eseguire un nodo Bitcoin Core

Una volta compilato e installato Bitcoin Core, sei pronto per eseguirlo. Eseguirai un _full node_, il che significa che scaricherà l'intera blockchain di Bitcoin (attualmente diverse centinaia di gigabyte) e convaliderà completamente ogni blocco e transazione. Questo processo può richiedere diversi giorni o anche settimane, a seconda della velocità della tua connessione internet e delle prestazioni della CPU. Durante questo tempo, il tuo nodo si sincronizzerà con la rete. Devi lasciarlo funzionare senza interruzioni. Puoi fermarlo e riavviarlo, e riprenderà da dove si è fermato, ma è meglio lasciare che completi il download iniziale dei blocchi (IBD) in una volta sola.

Prima di avviare il nodo, dovresti creare un file di configurazione per controllarne il funzionamento. Il file di configurazione si chiama _bitcoin.conf_ e si trova nella directory dei dati di Bitcoin. Per impostazione predefinita, questa è _~/.bitcoin/_ su Linux. Puoi anche specificare una directory dei dati diversa con l'opzione +-datadir+.

Crea la directory dei dati di Bitcoin:

----
$ mkdir ~/.bitcoin
----

Ora, crea il file di configurazione in quella directory. Puoi utilizzare qualsiasi editor di testo. Qui utilizziamo +nano+:

----
$ nano ~/.bitcoin/bitcoin.conf
----

Aggiungi le seguenti righe al file di configurazione:

----
rpcuser=bitcoinrpc
rpcpassword=CAMBIA_QUESTO

rpcallowip=127.0.0.1

# Abilita le notifiche ZMQ
zmqpubrawblock=tcp://127.0.0.1:28332
zmqpubrawtx=tcp://127.0.0.1:28333
----

Questo file di configurazione imposta l'interfaccia Remote Procedure Call (RPC), che ti consente di interagire con il nodo dalla riga di comando o da altri programmi. +rpcuser+ e +rpcpassword+ sono utilizzati per l'autenticazione. Scegli una password forte e casuale per +rpcpassword+. L'impostazione +rpcallowip+ limita le connessioni RPC alla tua macchina locale (localhost), per sicurezza.

[ATTENZIONE]
====
Non utilizzare la password di esempio mostrata qui. Scegli una password forte e casuale per +rpcpassword+. Se esponi la porta RPC a internet, una password debole potrebbe consentire a un attaccante di prendere il controllo del tuo nodo e rubare i tuoi bitcoin.
====

Il file di configurazione abilita anche le notifiche ZMQ, che utilizzeremo più avanti in questo capitolo per ottenere aggiornamenti in tempo reale dalla rete.

Ora sei pronto per avviare il nodo Bitcoin Core. Esegui il comando +bitcoind+:

----
$ bitcoind -daemon
Bitcoin Core starting
----

L'opzione +-daemon+ dice a +bitcoind+ di funzionare in background come processo server. Puoi vedere lo stato del nodo guardando il file di log di debug, _debug.log_, nella directory dei dati di Bitcoin. Utilizza il comando +tail -f+ per guardare il file di log in tempo reale:

----
$ tail -f ~/.bitcoin/debug.log
2023-01-01T12:00:00Z Pre-allocating up to 465 MiB for block/undo files.
2023-01-01T12:00:00Z UpdateTip: new best=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f height=0 version=0x00000001 log2_work=32.000014 tx=1 date='2009-01-03T18:15:05Z' progress=0.000000 cache=0.0MiB(1txo)
2023-01-01T12:00:01Z UpdateTip: new best=00000000839a8e6886ab5951d76f411475428afc90947ee320161bbf18eb6048 height=1 version=0x00000001 log2_work=38.000048 tx=2 date='2009-01-09T02:54:25Z' progress=0.000000 cache=0.0MiB(2txo)
...
----

Il nodo è ora in esecuzione e si sta sincronizzando con la rete. Puoi interagire con esso utilizzando lo strumento a riga di comando +bitcoin-cli+. Ad esempio, per ottenere informazioni generali sullo stato del nodo, esegui:

----
$ bitcoin-cli getblockchaininfo
{
  "chain": "main",
  "blocks": 277316,
  "headers": 770000,
  "bestblockhash": "000000000000000005f33b135c6e7814e4165a2941dc8b5bd65c342342af3898",
  "difficulty": 3.89624344151399e+12,
  "mediantime": 1388185032,
  "verificationprogress": 0.08333333333333333,
  "initialblockdownload": true,
  "chainwork": "0000000000000000000000000000000000000000000000000000000000000000",
  "size_on_disk": 171382338,
  "pruned": false,
  "warnings": ""
}
----

Il comando +getblockchaininfo+ restituisce un oggetto JSON con informazioni sulla blockchain, come il numero di blocchi, la difficoltà attuale e il progresso di verifica. Il campo +verificationprogress+ mostra quanto della blockchain è stata scaricata e convalidata. Il campo +initialblockdownload+ è +true+ fino a quando il nodo non è completamente sincronizzato.

Mentre il nodo si sta sincronizzando, puoi comunque utilizzarlo per esplorare la blockchain, ma vedrai solo i dati che sono stati scaricati finora. Aspetta fino a quando +initialblockdownload+ è +false+ prima di poter considerare il nodo completamente sincronizzato.

Il comando +getblockchaininfo+ restituisce un oggetto JSON con informazioni sulla blockchain, come il numero di blocchi, la difficoltà attuale e il progresso di verifica. Il campo +verificationprogress+ mostra quanto della blockchain è stata scaricata e convalidata. Il campo +initialblockdownload+ è +true+ fino a quando il nodo non è completamente sincronizzato.

Mentre il tuo nodo si sta sincronizzando, puoi comunque utilizzarlo per esplorare la blockchain, ma vedrai solo i dati che sono stati scaricati finora. Aspetta fino a quando +initialblockdownload+ è +false+ prima di poter considerare il tuo nodo completamente sincronizzato.

=== L'Application Programming Interface (API) di Bitcoin Core

Il comando +bitcoin-cli+ è solo un modo per interagire con il tuo nodo Bitcoin Core. Il nodo fornisce anche un'interfaccia programmabile, l'API, che ti consente di scrivere programmi che interagiscono con la rete Bitcoin. L'API è basata su JSON-RPC, il che significa che puoi chiamare le funzioni API inviando richieste formattate in JSON al server RPC del nodo.

[NOTA]
====
L'API di Bitcoin Core è estesa e ben documentata. Puoi trovare la documentazione completa dell'API sul https://bitcoincore.org/en/doc/[sito web della documentazione di Bitcoin Core]. In questo libro, copriremo solo un piccolo sottoinsieme delle chiamate API disponibili.
====

Per utilizzare l'API, devi conoscere il nome utente e la password RPC che hai impostato nel file _bitcoin.conf_. Puoi quindi utilizzare qualsiasi linguaggio di programmazione che supporti HTTP e JSON per effettuare chiamate API. Negli esempi seguenti, utilizzeremo Python, un linguaggio popolare per scripting e sviluppo web.

Prima, scriviamo un semplice script Python per connettersi al nodo Bitcoin Core e ottenere le stesse informazioni del comando +getblockchaininfo+. Crea un file chiamato _rpc_example.py_ e aggiungi il seguente codice:

----
import requests
import json

# Configura la connessione RPC
rpc_user = 'bitcoinrpc'
rpc_password = 'CAMBIA_QUESTO'
rpc_host = '127.0.0.1'
rpc_port = 8332

# Crea l'URL RPC
rpc_url = f"http://{rpc_user}:{rpc_password}@{rpc_host}:{rpc_port}/"

# Prepara la richiesta JSON-RPC
headers = {'content-type': 'application/json'}

# Chiama il metodo getblockchaininfo
payload = json.dumps({
    "method": "getblockchaininfo",
    "params": [],
    "jsonrpc": "2.0",
    "id": 0,
})

# Invia la richiesta e ottieni la risposta
response = requests.post(rpc_url, headers=headers, data=payload)

# Stampa la risposta
print(response.json())
----

Sostituisci +CAMBIA_QUESTO+ con la password forte che hai scelto per il tuo file _bitcoin.conf_. Poi, esegui lo script dalla riga di comando:

----
$ python rpc_example.py
{'result': {'chain': 'main', 'blocks': 277316, ...}, 'error': None, 'id': 0}
----

L'output è un oggetto JSON contenente il risultato della chiamata API. Il campo +result+ contiene le stesse informazioni del comando +getblockchaininfo+.

Questo esempio mostra i principi di base dell'utilizzo dell'API di Bitcoin Core. Puoi chiamare qualsiasi metodo API cambiando il campo +method+ nella richiesta JSON. Ad esempio, per ottenere informazioni su un blocco specifico, puoi utilizzare il metodo +getblock+ e passare l'hash del blocco come parametro.

Proviamo un altro esempio. Questa volta, otterremo i dettagli del primo blocco Bitcoin, noto come _genesis block_. Avremo bisogno del suo hash, che è:

+000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f+

Modifica lo script _rpc_example.py_ per chiamare il metodo +getblock+ con questo hash:

----
# Chiama il metodo getblock
payload = json.dumps({
    "method": "getblock",
    "params": ["000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f"],
    "jsonrpc": "2.0",
    "id": 0,
})
----

Esegui nuovamente lo script:

----
$ python rpc_example.py
{'result': {'hash': '000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f', 'confirmations': 770001, ...}, 'error': None, 'id': 0}
----

L'output mostra i dettagli del genesis block, incluso il suo hash, il numero di conferme e le transazioni che contiene.

==== Esplorare e decodificare transazioni

Le transazioni sono la parte più importante del sistema Bitcoin. Sono le strutture dati che trasferiscono valore tra gli utenti. Utilizziamo l'API per esplorare una transazione. Utilizzeremo la prima transazione mai effettuata, che è la transazione coinbase del genesis block. Il suo ID transazione (txid) è:

+4a5e1e4baab89f3a32518a88c31bc87f618f76673e2cc77ab2127b7afdeda33b+

Possiamo utilizzare il metodo +getrawtransaction+ per ottenere i dati grezzi della transazione come stringa esadecimale. Poi utilizziamo il metodo +decoderawtransaction+ per decodificare la stringa esadecimale in un oggetto JSON leggibile dall'uomo.

Modifica lo script _rpc_example.py_ come segue:

----
# Ottieni i dati grezzi della transazione
payload = json.dumps({
    "method": "getrawtransaction",
    "params": ["4a5e1e4baab89f3a32518a88c31bc87f618f76673e2cc77ab2127b7afdeda33b"],
    "jsonrpc": "2.0",
    "id": 0,
})
response = requests.post(rpc_url, headers=headers, data=payload)
raw_tx = response.json()['result']

# Decodifica la transazione grezza
payload = json.dumps({
    "method": "decoderawtransaction",
    "params": [raw_tx],
    "jsonrpc": "2.0",
    "id": 0,
})
response = requests.post(rpc_url, headers=headers, data=payload)
decoded_tx = response.json()['result']

# Stampa la transazione decodificata
print(json.dumps(decoded_tx, indent=4))
----

Esegui lo script:

----
$ python rpc_example.py
{
    "txid": "4a5e1e4baab89f3a32518a88c31bc87f618f76673e2cc77ab2127b7afdeda33b",
    "hash": "4a5e1e4baab89f3a32518a88c31bc87f618f76673e2cc77ab2127b7afdeda33b",
    "version": 1,
    "size": 204,
    "vsize": 204,
    "weight": 816,
    "locktime": 0,
    "vin": [
        {
            "coinbase": "04ffff001d0104455468652054696d65732030332f4a616e2f32303039204368616e63656c6c6f72206f6e206272696e6b206f66207365636f6e64206261696c6f757420666f722062616e6b73",
            "sequence": 4294967295
        }
    ],
    "vout": [
        {
            "value": 50.00000000,
            "n": 0,
            "scriptPubKey": {
                "asm": "04678afdb0fe5548271967f1a67130b7105cd6a828e03909a67962e0ea1f61deb649f6bc3f4cef38c4f35504e51ec112de5c384df7ba0b8d578a4c702b6bf11d5f OP_CHECKSIG",
                "hex": "4104678afdb0fe5548271967f1a67130b7105cd6a828e03909a67962e0ea1f61deb649f6bc3f4cef38c4f35504e51ec112de5c384df7ba0b8d578a4c702b6bf11d5f51ac",
                "reqSigs": 1,
                "type": "pubkey",
                "addresses": [
                    "1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"
                ]
            }
        }
    ]
}
----

La transazione decodificata mostra la sua struttura, inclusi gli input (+vin+) e gli output (+vout+). Il +vin+ di una transazione coinbase è speciale e contiene un campo +coinbase+ con dati arbitrari. Nel genesis block, questo campo contiene il famoso messaggio di Satoshi Nakamoto:

"The Times 03/Jan/2009 Chancellor on brink of second bailout for banks"

Il +vout+ mostra che questa transazione ha creato un singolo output di 50 bitcoin, che è stato inviato all'indirizzo +1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa+. Questo è stato il primo indirizzo Bitcoin mai creato.

==== Utilizzare l'API di Bitcoin Core con librerie Python

Scrivere richieste JSON-RPC grezze può essere noioso. Fortunatamente, ci sono diverse librerie Python che semplificano il processo di interazione con l'API di Bitcoin Core. Una di queste librerie è +python-bitcoinlib+, che utilizzeremo negli esempi seguenti.

Prima, installa la libreria utilizzando +pip+:

----
$ pip install python-bitcoinlib
----

Ora, riscriviamo l'esempio precedente utilizzando +python-bitcoinlib+. Crea un file chiamato _rpc_lib_example.py_ e aggiungi il seguente codice:

----
from bitcoin.rpc import RawProxy

# Crea una connessione al nodo Bitcoin Core locale
p = RawProxy()

# Ottieni l'hash del blocco 277316
blockhash = p.getblockhash(277316)

# Recupera il blocco tramite il suo hash
block = p.getblock(blockhash)

# Ottieni la prima transazione nel blocco
txid = block['tx'][0]

# Ottieni i dati grezzi della transazione
raw_tx = p.getrawtransaction(txid)

# Decodifica la transazione grezza
decoded_tx = p.decoderawtransaction(raw_tx)

# Stampa la transazione decodificata
import json
print(json.dumps(decoded_tx, indent=4))
----

La libreria +python-bitcoinlib+ fornisce una classe +RawProxy+ che gestisce la connessione RPC e la serializzazione JSON per te. Puoi chiamare i metodi API direttamente sull'oggetto +RawProxy+, e la libreria si occuperà del resto.

Questo codice fa la stessa cosa dell'esempio precedente, ma è molto più pulito e facile da leggere. Prima ottiene l'hash del blocco 277316, poi recupera il blocco, ottiene la prima transazione e infine la decodifica e la stampa.

==== Ottenere notifiche in tempo reale con ZMQ

Oltre all'interfaccia RPC, Bitcoin Core può anche fornire notifiche in tempo reale degli eventi di rete utilizzando la libreria di messaggistica ZeroMQ (ZMQ). Questo è utile per applicazioni che devono reagire rapidamente a nuovi blocchi e transazioni.

Per utilizzare ZMQ, devi abilitarlo nel tuo file _bitcoin.conf_, come abbiamo fatto prima. Devi anche installare la libreria Python +pyzmq+:

----
$ pip install pyzmq
----

Ora, puoi scrivere uno script Python per iscriverti alle notifiche ZMQ. Crea un file chiamato _zmq_example.py_ e aggiungi il seguente codice:

----
import zmq
import binascii

# Crea un contesto ZMQ
context = zmq.Context()

# Crea un socket ZMQ
socket = context.socket(zmq.SUB)

# Connettiti al publisher ZMQ di Bitcoin Core
socket.connect("tcp://127.0.0.1:28332")

# Iscriviti alle notifiche di blocchi grezzi
socket.setsockopt_string(zmq.SUBSCRIBE, "rawblock")

print("In attesa di nuovi blocchi...")

while True:
    # Ricevi un messaggio
    msg = socket.recv_multipart()

    # Spacchetta il messaggio
    topic = msg[0].decode('utf-8')
    body = binascii.hexlify(msg[1]).decode('utf-8')
    sequence = int.from_bytes(msg[2], 'little')

    print(f"Topic: {topic}, Sequence: {sequence}")
    print(f"Body: {body[:64]}...")
----

Questo script si connette al publisher ZMQ sulla porta 28332 e si iscrive alle notifiche +rawblock+. Quando un nuovo blocco viene ricevuto dal tuo nodo, pubblicherà un messaggio con il topic +rawblock+ e i dati grezzi del blocco come corpo. Lo script stamperà poi il topic, il numero di sequenza e i primi 64 caratteri dei dati del blocco.

Esegui lo script dalla riga di comando:

----
$ python zmq_example.py
In attesa di nuovi blocchi...
----

Lo script ora aspetterà nuovi blocchi. Quando viene trovato un nuovo blocco, vedrai un output come questo:

----
Topic: rawblock, Sequence: 12345
Body: 0100000000000000000000000000000000000000000000000000000000000000...
----

Puoi anche iscriverti alle notifiche +rawtx+ sulla porta 28333 per ottenere aggiornamenti in tempo reale sulle nuove transazioni.

=== Argomenti avanzati

In questo capitolo, abbiamo solo scalfito la superficie di quello che puoi fare con Bitcoin Core. Ci sono molti altri argomenti avanzati da esplorare, come:

* Creare e firmare transazioni
* Gestire un wallet
* Minare blocchi (sulla rete di test)
* Partecipare alla rete peer-to-peer

Copriremo alcuni di questi argomenti nei capitoli successivi. Per ora, hai una solida base per lavorare con Bitcoin Core e la rete Bitcoin.

=== Riepilogo

In questo capitolo, abbiamo installato e configurato Bitcoin Core, l'implementazione di riferimento del sistema Bitcoin. Abbiamo imparato come eseguire un full node, sincronizzarlo con la rete e interagire con esso utilizzando l'interfaccia a riga di comando e l'API JSON-RPC. Abbiamo anche esplorato come utilizzare le librerie Python per semplificare l'accesso all'API e come ottenere notifiche in tempo reale con ZMQ. Ora sei equipaggiato con gli strumenti e le conoscenze per esplorare la blockchain di Bitcoin e costruire le tue applicazioni Bitcoin.

[[rpc_example]]
.Running +getblockchaininfo+ via Bitcoin Core's JSON-RPC API
====
----
include::code/rpc_example.py[]
----
====

Eseguendolo, otteniamo il seguente risultato:

----
$ python rpc_example.py
773973
----

Ci mostra quanti blocchi sono presenti nella blockchain del nostro nodo locale di Bitcoin Core. Anche se non è un risultato particolarmente impressionante, dimostra l'utilizzo basilare della libreria come interfaccia semplificata per l'API JSON-RPC di Bitcoin Core.

Proseguiamo utilizzando le chiamate +getrawtransaction+ e +decodetransaction+ per recuperare i dettagli del pagamento di Alice a Bob. In <<rpc_transaction>>, recuperiamo la transazione di Alice ed elenchiamo gli output della transazione.
Per ogni output, mostriamo l'indirizzo del destinatario e il valore. Ricordiamo che la transazione di Alice aveva un output per il pagamento a Bob e un output per il resto destinato ad Alice.

[[rpc_transaction]]
.Retrieving a transaction and iterating its outputs
====
----
include::code/rpc_transaction.py[]
----
====

Eseguendo questo codice, otteniamo:

----
$ python rpc_transaction.py
bc1p8dqa4wjvnt890qmfws83te0v3qxzsfu7ul63kp7u56w8qc0qwp5qv995qn 0.00020000
bc1qwafvze0200nh9vkq4jmlf4sy0tn0ga5w0zpkpg 0.00075000
----

Entrambi gli esempi precedenti sono piuttosto semplici. Non hai davvero bisogno di un programma per eseguirli; potresti facilmente utilizzare l'helper +bitcoin-cli+. Tuttavia, il prossimo esempio richiede diverse centinaia di chiamate RPC e dimostra più chiaramente l'utilizzo di un'interfaccia programmabile.

In <<rpc_block>>, iniziamo recuperando un blocco e poi estraiamo tutte le transazioni contenute al suo interno utilizzando i rispettivi transaction ID. Poi, analizziamo gli output di ogni transazione e sommiamo i relativi valori.

[[rpc_block]]
.Retrieving a block and adding all the transaction outputs
====
----
include::code/rpc_block.py[]
----
====

Eseguendo questo codice, otteniamo:

----
$ python rpc_block.py

Total value in block:  10322.07722534
----

Il nostro codice di esempio calcola che il valore totale transato in questo blocco è di 10.322,07722534 BTC (inclusi 25 BTC di ricompensa e 0,0909 BTC di commissioni). Confrontalo con l'importo riportato da un block explorer cercando l'hash o l'altezza del blocco. Alcuni block explorer mostrano il valore totale escludendo sia la ricompensa sia le commissioni. Vedi se riesci a notare la differenza.

[[alt_libraries]]
=== Client, librerie e toolkit alternativi

Nell'ecosistema Bitcoin esistono numerosi client alternativi, librerie, toolkit e persino implementazioni complete di full node. Sono realizzati in vari linguaggi di programmazione, offrendo agli sviluppatori un'interfaccia nativa nel linguaggio che preferiscono.

Le sezioni seguenti elencano alcune tra le migliori librerie, client e toolkit, suddivisi per linguaggio di programmazione.

==== C/C++
https://oreil.ly/BdOwl[Bitcoin Core] :: La versione di riferimento di Bitcoin

==== JavaScript
https://bcoin.io[bcoin]:: Un full node progettato per essere modulare e scalabile, con supporto API
https://bitcore.io[Bitcore] :: Un full node con API e libreria, realizzato da Bitpay
https://oreil.ly/4iqf2[BitcoinJS] :: Una libreria Bitcoin scritta interamente in JavaScript, per node.js e browser

==== Java
https://bitcoinj.github.io[bitcoinj]:: Una libreria Java per client full node

==== Python
https://oreil.ly/xn_rg[python-bitcoinlib]::  Una libreria Bitcoin in Python, una libreria per il consenso e un full node sviluppati da Peter Todd
https://oreil.ly/wcpXP[pycoin]:: Una libreria Bitcoin in Python sviluppati da Richard Kiss

==== Go
https://oreil.ly/h5MEI[btcd]:: Un client Bitcoin full node scritto in linguaggio Go

==== Rust
https://oreil.ly/me6gf[rust-bitcoin]:: Una libreria Bitcoin scritta in Rust, pensata per la serializzazione, l'analisi dei dati e le chiamate API

==== Scala
https://bitcoin-s.org[bitcoin-s]:: Una versione di Bitcoin sviluppata in Scala

==== C#
https://oreil.ly/Qfjgq[NBitcoin]:: Una libreria Bitcoin completa pensata per il framework .NET

Molte altre librerie sono disponibili per un'ampia varietà di linguaggi di programmazione e ne vengono create continuamente di nuove.

Se hai seguito le istruzioni di questo capitolo, ora hai Bitcoin Core in esecuzione e hai iniziato a esplorare la rete e la blockchain con il tuo full node. Da questo momento in poi, puoi utilizzare in modo indipendente un software sotto il tuo controllo (su un computer che controlli tu) per verificare che i bitcoin che ricevi rispettino tutte le regole del sistema Bitcoin, senza dover fare affidamento su alcuna autorità esterna. Nei prossimi capitoli, approfondiremo le regole del sistema e scopriremo come il tuo nodo e il tuo wallet le utilizzino per mettere al sicuro i tuoi fondi, proteggere la tua privacy e rendere l'invio e la ricezione delle transazioni più convenient.
